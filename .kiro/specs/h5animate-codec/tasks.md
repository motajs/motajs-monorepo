# 实现计划: H5Animate 编解码器

## 概述

将设计转换为一系列增量实现任务，每个任务都基于前面的任务构建，最终完成完整的 h5animate 编解码系统。所有任务都专注于编写、修改或测试代码。

## 任务

- [x] 1. 设置项目结构和核心类型定义
  - 创建 TypeScript 接口和类型定义
  - 设置测试框架 (Vitest)
  - 定义错误类型和错误代码
  - _需求: 1.1, 2.1, 3.1_

- [x] 1.1 编写核心类型的单元测试
  - 测试类型定义的正确性
  - 验证错误类型的创建
  - _需求: 6.5_

- [x] 2. 实现二进制解析和写入工具
  - [x] 2.1 实现 BinaryParser 类
    - 实现 readUInt32LE、readString、readBytes 方法
    - 添加偏移量跟踪和边界检查
    - _需求: 1.3, 1.4_

  - [x] 2.2 实现 BinaryWriter 类
    - 实现 writeUInt32LE、writeString、writeBuffer 方法
    - 添加偏移量跟踪和缓冲区管理
    - _需求: 2.3, 2.4_

  - [x] 2.3 编写二进制工具的单元测试
    - 测试读写操作的正确性
    - 测试边界条件和错误处理
    - _需求: 6.1, 6.2_

- [x] 3. 实现 H5Animate 解码功能
  - [x] 3.1 实现文件头解析函数
    - 验证 "ANIM" 标识符
    - 提取版本号和数据大小信息
    - _需求: 1.1, 1.2_

  - [x] 3.2 实现精灵图信息解析函数
    - 解析精灵图数量和尺寸信息
    - 计算精灵图信息占用的字节数
    - _需求: 1.3_

  - [x] 3.3 实现数组到对象的转换函数
    - 将文件中的数组格式转换为内存中的对象格式
    - 处理可选字段的默认值
    - _需求: 5.4_

  - [x] 3.4 实现主解码函数
    - 整合文件头、精灵图信息和元数据解析
    - 返回完整的解码结果
    - _需求: 1.5_

  - [x] 3.5 编写解码功能的单元测试
    - 测试有效文件的解码
    - 测试无效文件的错误处理
    - 测试数组到对象的转换
    - _需求: 1.6, 6.1, 6.3_

- [x] 4. 检查点 - 确保解码功能正常工作
  - 确保所有测试通过，如有问题请询问用户

- [x] 5. 实现 H5Animate 编码功能
  - [x] 5.1 实现对象到数组的转换函数
    - 将内存中的对象格式转换为文件中的数组格式
    - 使用 JSON.stringify 的 replacer 参数
    - _需求: 2.4_

  - [x] 5.2 实现主编码函数
    - 使用 BinaryWriter 写入文件头
    - 写入精灵图信息和 WebP 数据
    - 写入序列化的元数据
    - _需求: 2.1, 2.2, 2.3_

  - [x] 5.3 编写编码功能的单元测试
    - 测试有效数据的编码
    - 测试对象到数组的转换
    - 测试无效输入的错误处理
    - _需求: 2.6, 6.4_

- [x] 6. 实现 WebP 图像处理功能
  - [x] 6.1 实现单个图像转换函数
    - 使用 Sharp 将 PNG 转换为 WebP
    - 支持无损和有损压缩模式
    - _需求: 4.5_

  - [x] 6.2 实现垂直精灵图创建函数
    - 将多个图像垂直排列合并
    - 保持透明度信息
    - 生成精灵图尺寸信息
    - _需求: 4.1, 4.4_

  - [x] 6.3 实现帧提取函数
    - 从精灵图中提取单个帧
    - 支持按索引和位置提取
    - _需求: 4.3_

  - [x] 6.4 编写图像处理的单元测试
    - 测试图像格式转换
    - 测试精灵图创建和帧提取
    - 测试透明度保持
    - _需求: 4.4, 4.5_

- [x] 7. 实现格式转换功能
  - [x] 7.1 实现旧格式解析函数
    - 解析 JSON 格式的 .animate 文件
    - 验证必需字段的存在
    - _需求: 3.1, 5.2_

  - [x] 7.2 实现图像数据转换函数
    - 将 Base64 编码的 PNG 转换为 WebP
    - 生成精灵图信息
    - _需求: 3.2_

  - [x] 7.3 实现元数据转换函数
    - 将旧格式的帧数据转换为新格式
    - 处理音效配置的转换
    - 映射所有对象属性
    - _需求: 3.3, 3.4, 5.3_

  - [x] 7.4 实现主转换函数
    - 整合图像转换和元数据转换
    - 调用编码函数生成最终文件
    - _需求: 3.5_

  - [x] 7.5 编写格式转换的单元测试
    - 使用真实的 .animate 文件测试
    - 验证转换结果的正确性
    - 测试错误处理
    - _需求: 3.6, 6.2_

- [x] 8. 实现往返一致性测试
  - [x] 8.1 编写编解码往返测试
    - 测试编码后解码的数据一致性
    - 使用多种不同的测试数据
    - _需求: 2.5_

  - [x] 8.2 编写转换往返测试
    - 测试旧格式转换后的数据完整性
    - 验证所有字段的正确映射
    - _需求: 3.5_

- [x] 9. 实现错误处理和验证
  - [x] 9.1 增强错误处理逻辑
    - 为所有错误类型提供唯一错误代码
    - 添加详细的错误描述和位置信息
    - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_

  - [x] 9.2 实现输入验证函数
    - 验证元数据结构的完整性
    - 检查必需字段和数据类型
    - _需求: 5.1, 5.2_

  - [x] 9.3 编写错误处理的单元测试
    - 测试各种错误情况
    - 验证错误代码和消息的正确性
    - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 10. 创建主 API 接口
  - [x] 10.1 实现用户友好的 API 函数
    - 创建简化的编码、解码和转换接口
    - 添加适当的类型注解和文档
    - _需求: 1.1, 2.1, 3.1_

  - [x] 10.2 导出所有公共接口
    - 在 lib/index.ts 中导出主要函数和类型
    - 确保 API 的一致性和易用性
    - _需求: 1.1, 2.1, 3.1_

- [x] 11. 最终检查点 - 确保所有功能正常工作
  - 运行完整的测试套件
  - 验证所有需求都已实现
  - 确保所有测试通过，如有问题请询问用户

- [ ] 12. 性能测试
  - 创建 100MB 的测试文件
  - 验证内存使用情况
  - _需求: 7.5_

## 注意事项

- 每个任务都引用了具体的需求以确保可追溯性
- 检查点确保增量验证
- 所有测试都使用 Vitest 框架
- 重点关注核心功能的正确实现和全面的测试覆盖